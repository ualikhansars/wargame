import Unit from '../../../unit/types/Unit';
import {getSurroundedAllies, getSurroundedEnemies} from '../../../utils/surrounded';
import { calculateTotalUnitsWeight } from '../weight/calculateUnitsWeight';
import { getDangerousUnits, containsDangerousUnits } from '../../../utils/unit/AI/AI_actions';

export const assessVulnerability = (unit: Unit): number => {
    let vulnerability = 0;
    const nearestAllies: Unit[] = getSurroundedAllies(unit);
    const nearestEnemies: Unit[] = getSurroundedEnemies(unit);
    const nearestAlliesWeight: number = calculateTotalUnitsWeight(nearestAllies) + unit.weight;
    const nearestEnemiesWeight: number = calculateTotalUnitsWeight(nearestEnemies);
    const numberOfDangerousUnits: number = getDangerousUnits(unit).length;
    const containsDangerousUnitsNearby: boolean = containsDangerousUnits(unit, nearestEnemies);

    console.log('unit', unit.name);
    console.log('nearestAlliesWeight', nearestAlliesWeight);
    console.log('nearestEnemiesWeight', nearestEnemiesWeight);
    console.log('nearestAlliesNumber', nearestAllies.length);
    console.log('nearestEnemiesNumber', nearestEnemies.length);
    console.log('numberOfDangerousUnits', numberOfDangerousUnits);
    
    
    if(nearestAllies.length === 0 && nearestEnemies.length === 0) {
        vulnerability += 10;
    }
    
    if(nearestAllies.length === 0 && containsDangerousUnitsNearby) {
        vulnerability += 70;
    }

    if(nearestAllies.length === 0 && nearestEnemies.length > 0) {
        if(containsDangerousUnitsNearby) {
            vulnerability += 70;
        } 
        if(nearestEnemiesWeight / nearestAlliesWeight >= 1.5) {
            vulnerability += 80;
        } else {
            vulnerability += 30;
        } 
    }

    if(nearestAllies.length > 0 && nearestEnemies.length > 0) {
        vulnerability += 10;
        if(containsDangerousUnitsNearby) {
            vulnerability += 30;
        }
        if(nearestEnemiesWeight / nearestAlliesWeight >= 1.2) {
            vulnerability += 50;
        } 
        else if(nearestAlliesWeight / nearestEnemiesWeight >= 1.2) {
            vulnerability -= 20;
        }
    }

    if(numberOfDangerousUnits > 0) {
        vulnerability += 30;
    }

    if(vulnerability < 0) vulnerability = 0;
    else if(vulnerability > 100) vulnerability = 100;

    return vulnerability;
}